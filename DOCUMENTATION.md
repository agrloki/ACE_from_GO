# Документация по проекту ACE

## Общее описание

ACE (Advanced Control Electronics) - это система управления для 3D-принтера, предназначенная для управления подачей филамента, сенсорами, сушкой и другими функциями, связанными с подачей материала. Проект состоит из нескольких основных компонентов:

- `ace.py` - основной модуль, реализующий логику управления
- `ace_commun.py` - модуль для коммуникации с устройством ACE
- `ace.cfg` - конфигурационный файл

## Структура проекта

```
ace.cfg                    # Конфигурационный файл
extras/
├── ace.py               # Основной модуль управления
└── ace_commun.py        # Модуль коммуникации
```

## Конфигурационный файл (ace.cfg)

### Параметры конфигурации

- `serial` - путь к последовательному порту для подключения к устройству ACE (по умолчанию: `/dev/ttyACM0`)
- `baud` - скорость передачи данных по последовательному порту (по умолчанию: `115200`)
- `extruder_sensor_pin` - пин для датчика филамента в экструдере (по умолчанию: `None`)
- `endless_spool` - включить функцию бесконечного спулера (по умолчанию: `False`)

### Дополнительные параметры (устанавливаемые в коде, но не в конфигурации)

- `feed_speed` - скорость подачи филамента (по умолчанию: `50`)
- `retract_speed` - скорость отката филамента (по умолчанию: `50`)
- `toolchange_retract_length` - длина отката при смене инструмента (по умолчанию: `150`)
- `toolchange_load_length` - длина загрузки при смене инструмента (по умолчанию: `630`)
- `toolhead_sensor_to_nozzle` - расстояние от сенсора до сопла (по умолчанию: `0`)
- `max_dryer_temperature` - максимальная температура сушки (по умолчанию: `55`)

## Модуль ace.py

### Класс ACE

Основной класс, реализующий всю логику управления устройством ACE.

#### Методы инициализации

##### `__init__(self, config)`
Инициализирует объект ACE с заданной конфигурацией.

**Параметры:**
- `config` - объект конфигурации Klipper

**Описание:**
- Устанавливает параметры подключения (последовательный порт, скорость)
- Создает объект для коммуникации с устройством
- Устанавливает пины для сенсоров
- Настраивает скорости и длины для подачи/отката филамента
- Инициализирует настройки бесконечного спулера
- Создает таймеры и обработчики событий
- Регистрирует G-код команды

##### `_init_inventory(self)`
Инициализирует инвентарь слотов филамента.

**Описание:**
- Создает начальное состояние инвентаря с 4 слотами
- Загружает сохраненный инвентарь из переменных

##### `_create_mmu_sensor(self, config, pin, name)`
Создает сенсор филамента.

**Параметры:**
- `config` - объект конфигурации
- `pin` - пин для сенсора
- `name` - имя сенсора

**Описание:**
- Создает объект `filament_switch_sensor` с заданными параметрами
- Регистрирует сенсор в системе контроля концевиков

#### Обработчики событий

##### `_handle_ready(self)`
Обработчик события готовности принтера.

**Описание:**
- Устанавливает соединение с устройством ACE
- Запускает таймер подключения

##### `_handle_disconnect(self)`
Обработчик события отключения принтера.

**Описание:**
- Закрывает соединение с устройством ACE

#### Методы подключения

##### `_connect(self, eventtime)`
Пытается подключиться к устройству ACE.

**Параметры:**
- `eventtime` - время события

**Описание:**
- Пытается установить соединение с устройством
- При успешном подключении регистрирует FD в реакторе
- Запрашивает информацию о прошивке
- Запускает таймеры heartbeat и endless spool монитора
- Восстанавливает feed assist при переподключении

##### `_disconnect(self)`
Отключается от устройства ACE.

**Описание:**
- Останавливает таймеры
- Отменяет регистрацию FD
- Закрывает соединение

##### `calc_reconnect_timeout(self, attempt)`
Рассчитывает таймаут для повторного подключения.

**Параметры:**
- `attempt` - номер попытки подключения

**Возвращает:**
- Время таймаута в секундах

#### Методы обработки данных

##### `write_handle(self, eventtime)`
Обработчик события записи в устройство.

**Параметры:**
- `eventtime` - время события

**Описание:**
- Вызывает метод записи из модуля коммуникации
- Управляет состоянием FD в реакторе

##### `read_handle(self, eventtime)`
Обработчик события чтения из устройства.

**Параметры:**
- `eventtime` - время события

**Описание:**
- Вызывает метод чтения из модуля коммуникации
- Обрабатывает ошибки чтения и переподключение

#### Методы таймеров

##### `_periodic_heartbeat_event(self, eventtime)`
Периодическое событие проверки состояния устройства.

**Параметры:**
- `eventtime` - время события

**Описание:**
- Отправляет запрос на получение статуса устройства
- Запланировано с интервалом ~3 секунды

##### `_update_status(self, response)`
Обновляет статус устройства из ответа.

**Параметры:**
- `response` - ответ от устройства

**Описание:**
- Обновляет внутреннее состояние объекта информацией из ответа

#### Вспомогательные методы

##### `dwell(self, delay)`
Пауза выполнения на заданное время.

**Параметры:**
- `delay` - время паузы в секундах

##### `send_request(self, request, callback)`
Отправляет запрос на устройство ACE.

**Параметры:**
- `request` - словарь с запросом
- `callback` - функция обратного вызова для обработки ответа

##### `_check_endstop_state(self, name)`
Проверяет состояние концевика по имени.

**Параметры:**
- `name` - имя концевика

**Возвращает:**
- `True` если концевик сработал, иначе `False`

##### `wait_ace_ready(self)`
Ожидает готовности устройства ACE.

**Описание:**
- Блокирующая функция, ждет пока статус устройства не станет "ready"

##### `_extruder_move(self, length, speed)`
Двигает экструдер на заданное расстояние.

**Параметры:**
- `length` - расстояние перемещения
- `speed` - скорость перемещения

**Возвращает:**
- Новую позицию экструдера

#### Методы бесконечного спулера

##### `_endless_spool_monitor(self, eventtime)`
Монитор бесконечного спулера.

**Параметры:**
- `eventtime` - время события

**Описание:**
- Проверяет состояние печати и датчика обрыва филамента
- Адаптирует частоту проверки в зависимости от состояния печати

##### `_endless_spool_runout_handler(self)`
Обработчик обрыва филамента при включенном бесконечном спулере.

**Описание:**
- Проверяет наличие филамента в датчике
- Запускает смену спулера при необходимости

##### `_execute_endless_spool_change(self)`
Выполняет смену спулера в режиме бесконечного спулера.

**Описание:**
- Находит следующий доступный слот
- Выполняет смену филамента
- Обновляет статусы и переменные

##### `_find_next_available_slot(self, current)`
Находит следующий доступный слот филамента.

**Параметры:**
- `current` - текущий слот

**Возвращает:**
- Индекс следующего доступного слота или -1, если нет доступных

#### G-код команды

##### `cmd_ACE_START_DRYING(self, gcmd)`
Запускает сушку филамента.

**Параметры:**
- `gcmd` - объект G-кода

**Параметры команды:**
- `TEMP` - температура сушки (обязательный)
- `DURATION` - продолжительность сушки (по умолчанию: 240)

##### `cmd_ACE_STOP_DRYING(self, gcmd)`
Останавливает сушку филамента.

**Параметры:**
- `gcmd` - объект G-кода

##### `_enable_feed_assist(self, index)`
Включает вспомогательную подачу филамента.

**Параметры:**
- `index` - индекс слота

##### `cmd_ACE_ENABLE_FEED_ASSIST(self, gcmd)`
Включает вспомогательную подачу филамента (G-код команда).

**Параметры:**
- `gcmd` - объект G-кода

**Параметры команды:**
- `INDEX` - индекс слота (обязательный)

##### `_disable_feed_assist(self, index)`
Отключает вспомогательную подачу филамента.

**Параметры:**
- `index` - индекс слота

##### `cmd_ACE_DISABLE_FEED_ASSIST(self, gcmd)`
Отключает вспомогательную подачу филамента (G-код команда).

**Параметры:**
- `gcmd` - объект G-кода

**Параметры команды:**
- `INDEX` - индекс слота (по умолчанию: текущий индекс)

##### `_feed(self, index, length, speed)`
Подает филамент из указанного слота.

**Параметры:**
- `index` - индекс слота
- `length` - длина подачи
- `speed` - скорость подачи

##### `cmd_ACE_FEED(self, gcmd)`
Подает филамент из указанного слота (G-код команда).

**Параметры:**
- `gcmd` - объект G-кода

**Параметры команды:**
- `INDEX` - индекс слота (обязательный)
- `LENGTH` - длина подачи (обязательный)
- `SPEED` - скорость подачи (по умолчанию: feed_speed)

##### `_retract(self, index, length, speed)`
Откатывает филамент в указанный слот.

**Параметры:**
- `index` - индекс слота
- `length` - длина отката
- `speed` - скорость отката

##### `cmd_ACE_RETRACT(self, gcmd)`
Откатывает филамент в указанный слот (G-код команда).

**Параметры:**
- `gcmd` - объект G-кода

**Параметры команды:**
- `INDEX` - индекс слота (обязательный)
- `LENGTH` - длина отката (обязательный)
- `SPEED` - скорость отката (по умолчанию: retract_speed)

##### `_feed_to_toolhead(self, tool)`
Подает филамент из указанного слота до сопла.

**Параметры:**
- `tool` - индекс слота

##### `cmd_ACE_CHANGE_TOOL(self, gcmd)`
Сменяет инструмент (филамент).

**Параметры:**
- `gcmd` - объект G-кода

**Параметры команды:**
- `TOOL` - индекс слота (обязательный)

##### `cmd_ACE_ENABLE_ENDLESS_SPOOL(self, gcmd)`
Включает режим бесконечного спулера.

**Параметры:**
- `gcmd` - объект G-кода

##### `cmd_ACE_DISABLE_ENDLESS_SPOOL(self, gcmd)`
Отключает режим бесконечного спулера.

**Параметры:**
- `gcmd` - объект G-кода

##### `cmd_ACE_ENDLESS_SPOOL_STATUS(self, gcmd)`
Показывает статус режима бесконечного спулера.

**Параметры:**
- `gcmd` - объект G-кода

##### `cmd_ACE_DEBUG(self, gcmd)`
Отправляет отладочный запрос на устройство.

**Параметры:**
- `gcmd` - объект G-кода

**Параметры команды:**
- `METHOD` - метод для вызова (обязательный)
- `PARAMS` - параметры в формате JSON (опционально)

##### `cmd_ACE_SET_SLOT(self, gcmd)`
Устанавливает параметры слота филамента.

**Параметры:**
- `gcmd` - объект G-кода

**Параметры команды:**
- `INDEX` - индекс слота (обязательный)
- `EMPTY` - установить слот как пустой (опционально)
- `COLOR` - цвет филамента в формате R,G,B (опционально)
- `MATERIAL` - тип материала (опционально)
- `TEMP` - температура печати (опционально)

##### `cmd_ACE_QUERY_SLOTS(self, gcmd)`
Запрашивает информацию о слотах филамента.

**Параметры:**
- `gcmd` - объект G-кода

##### `cmd_ACE_SAVE_INVENTORY(self, gcmd)`
Сохраняет инвентарь слотов филамента.

**Параметры:**
- `gcmd` - объект G-кода

##### `cmd_ACE_TEST_RUNOUT_SENSOR(self, gcmd)`
Тестирует датчик обрыва филамента.

**Параметры:**
- `gcmd` - объект G-кода

#### Методы состояния

##### `get_status(self, eventtime)`
Возвращает статус устройства ACE.

**Параметры:**
- `eventtime` - время события

**Возвращает:**
- Словарь с информацией о состоянии устройства

### Функция загрузки

##### `load_config(config)`
Функция загрузки конфигурации для Klipper.

**Параметры:**
- `config` - объект конфигурации

**Возвращает:**
- Объект класса ACE

## Модуль ace_commun.py

### Класс AceCommun

Класс для коммуникации с устройством ACE через последовательный порт или TCP.

#### Методы инициализации

##### `__init__(self, name, baud)`
Инициализирует объект коммуникации.

**Параметры:**
- `name` - имя порта (путь к последовательному порту или адрес TCP в формате "tcp@host:port")
- `baud` - скорость передачи данных

#### Методы подключения

##### `check_port_exists(self, path)`
Проверяет существование порта.

**Параметры:**
- `path` - путь к порту

**Возвращает:**
- `True` если порт существует, иначе `False`

##### `connect(self)`
Подключается к устройству ACE.

**Возвращает:**
- `None` при успешном подключении, иначе исключение

##### `disconnect(self)`
Отключается от устройства ACE.

#### Методы получения данных

##### `get_fd(self)`
Получает файловый дескриптор для регистрации в реакторе.

**Возвращает:**
- Файловый дескриптор или -1 при ошибке

#### Методы отправки данных

##### `_send_request(self, req)`
Отправляет запрос на устройство ACE.

**Параметры:**
- `req` - словарь с запросом

**Описание:**
- Формирует фрейм с запросом
- Добавляет заголовки, CRC и завершающий байт
- Отправляет данные через последовательный порт или TCP

##### `writer(self, eventtime)`
Метод записи данных в устройство.

**Параметры:**
- `eventtime` - время события

**Описание:**
- Извлекает запрос из очереди
- Отправляет его на устройство

##### `push_send_queue(self, request, callback)`
Добавляет запрос в очередь отправки.

**Параметры:**
- `request` - словарь с запросом
- `callback` - функция обратного вызова

##### `is_send_queue_empty(self)`
Проверяет, пуста ли очередь отправки.

**Возвращает:**
- `True` если очередь пуста, иначе `False`

#### Методы получения данных

##### `reader(self, eventtime)`
Метод чтения данных из устройства.

**Параметры:**
- `eventtime` - время события

**Возвращает:**
- `None` при успешном чтении, иначе сообщение об ошибке

**Описание:**
- Читает данные из последовательного порта или TCP
- Обрабатывает фреймы, проверяет CRC
- Вызывает соответствующие функции обратного вызова

#### Вспомогательные функции

##### `_calc_crc(data)`
Рассчитывает CRC для данных.

**Параметры:**
- `data` - байтовая строка данных

**Возвращает:**
- CRC значение

## Протокол коммуникации

### Формат фрейма

Фреймы данных имеют следующий формат:

- 2 байта заголовка: `0xFF 0xAA`
- 2 байта длины полезной нагрузки (младший байт первым)
- Полезная нагрузка (JSON в байтовом формате)
- 2 байта CRC (младший байт первым)
- 1 байт завершения: `0xFE`

### Типичные запросы и ответы

#### Запрос информации о прошивке
Запрос: `{"method": "get_info"}`
Ответ: `{"id": N, "result": {...}}`

#### Запрос статуса
Запрос: `{"method": "get_status"}`
Ответ: `{"id": N, "result": {...}}`

#### Сушка филамента
Запрос: `{"method": "drying", "params": {"temp": T, "fan_speed": S, "duration": D}}`
Ответ: `{"id": N, "code": C, "msg": "..."}`

## Ошибки и исключения

### Основные ошибки в ace_commun.py

- `RESPOND_TIMEOUT_ERROR` - "Respond timeout with the ACE PRO"
- `UNABLE_TO_COMMUN_ERROR` - "Unable to communicate with the ACE PRO"
- `OPEN_REMOTE_DEV_ERROR` - "Unable to open remote dev"
- `OPEN_SERIAL_DEV_ERROR` - "Unable to open serial port"
- `NOT_FOUND_SERIAL_ERROR` - "Not found serial port"

### Обработка ошибок

Все основные функции содержат обработку исключений с логированием ошибок и попытками восстановления соединения.

## Использование

Для использования модуля ACE необходимо:

1. Добавить секцию `[ace]` в конфигурацию Klipper
2. Указать параметры подключения в `ace.cfg`
3. Загрузить модуль в Klipper

Пример секции в конфигурации Klipper:
```
[ace]
serial: /dev/ttyACM0
baud: 115200
extruder_sensor_pin: ^PA4
endless_spool: True